<!DOCTYPE HTML>
<html>

<head>
    <title>C4</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
    <script type='application/javascript' src='pixi.js'></script>
    <script type='application/javascript' src='fastclick.js'></script>
</head>

<body>
    <script>
if ('addEventListener' in document) {
    document.addEventListener('DOMContentLoaded', function() {
        FastClick.attach(document.body);
    }, false);
}
        var now, then, delta;
        function timestamp() {
            return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
        }

var newBoard = function(rows, columns) {
    // private members
    // rows
    // columns
    var width = 0,
        height = 0;
    var pieceSize = {};
    pieceSize.width = 0;
    pieceSize.height = 0;

    var obj = {
        // width:height = columns:rows
        calcBoardSize: function() {
            height = window.innerHeight;
            height -= height % rows;
            width = columns * (height / rows);
            if (width > window.innerWidth) {
                width = window.innerWidth;
                width -= width % columns;
                height = rows * (width / columns);
            }
            pieceSize.width =
            pieceSize.height = width / columns;
        },
        getRows: function() {
            return rows;
        },
        getColumns: function() {
            return columns;
        },
        getWidth: function() {
            return width;
        },
        getHeight: function() {
            return height;
        },
        getPieceSize: function() {
            return pieceSize;
        },
        getPieceWidth: function() {
            return pieceSize.width;
        },
        getPieceHeight: function() {
            return pieceSize.height;
        },
        getBoard: function() {
            return board;
        }
    }
    obj.calcBoardSize();

    var board = new Array(rows);
    board.colcnt = new Array(columns);
    for (var col = 0; col < columns; col++) {
        board.colcnt[col] = 0;
        board[col] = new Array(rows);
        for (var row = 0; row < rows; row++) {
            board[col][row] = null;
        }
    }

    return obj;
}

var board = newBoard(6, 7);

        var tex = new Array(3);

            var state_player = 1;
            var state_piece_dropping = 2;
        var state = 0;

        var moverow, movecol;

        var faller = null;

        // create an new instance of a pixi stage with a grey background
        var stage = new PIXI.Stage(0x888888);
        // create a renderer instance
        board.calcBoardSize();
        var renderer = PIXI.autoDetectRenderer(board.getWidth(), board.getHeight());
        // create an empty container
        var gameContainer = new PIXI.DisplayObjectContainer();
        // add the container to the stage
        stage.addChild(gameContainer);
        // add the renderer view element to the DOM
        document.body.appendChild(renderer.view);

        var player = 1;
        window.addEventListener('orientationchange', resize, false);
        window.addEventListener('resize', resize, false);

        sizePieces(board.getPieceWidth(), board.getPieceHeight());
        setState(state_player);
        requestAnimFrame(animate);

        function sizePieces(piecewidth, pieceheight) {
            var texCanvas = document.createElement('canvas');
            texCanvas.width = piecewidth;
            texCanvas.height = pieceheight;
            var ctx = texCanvas.getContext('2d');
            var borderwidth = piecewidth/20;
            var radius = (piecewidth - borderwidth) / 2;
            ctx.beginPath();
            ctx.arc(piecewidth/2, pieceheight/2, radius, radius, 0, 2*Math.PI, false);
            ctx.fillStyle = 'blue';
            ctx.fill();
            ctx.lineWidth = piecewidth / 20;
            ctx.strokeStyle = 'darkblue';
            ctx.stroke();
            tex[1] = PIXI.Texture.fromCanvas(texCanvas);
            texCanvas = document.createElement('canvas');
            texCanvas.width = piecewidth;
            texCanvas.height = pieceheight;
            ctx = texCanvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(piecewidth/2, pieceheight/2, radius, radius, 0, 2*Math.PI, false);
            ctx.fillStyle = 'red';
            ctx.fill();
            ctx.lineWidth = piecewidth / 20;
            ctx.strokeStyle = 'darkred';
            ctx.stroke();
            tex[2] = PIXI.Texture.fromCanvas(texCanvas);
            var brd = board.getBoard();
            if (brd !== null) {
                for (var col = 0; col < board.getColumns(); col++) {
                    if (brd[col] !== null) {
                        for (var row = 0; row < board.getRows(); row++) {
                            var pos = brd[col][row];
                            if (pos !== null) {
                                pos.setTexture(tex[pos.player]);
                                pos.position.x = col * piecewidth;
                                pos.position.y = row * pieceheight;
                            }
                        }
                    }
                }
            }
        }

        function resize() {
            board.calcBoardSize();
            renderer.resize(board.getWidth(), board.getHeight());
            sizePieces(board.getPieceWidth(), board.getPieceHeight());
        }
        
        function setState(newstate) {
            switch (newstate) {
                case state_player:
                    canvas = document.getElementsByTagName("canvas")[0];
                    canvas.addEventListener("click", mouseDown, false);
                    break;
                case state_piece_dropping:
                    canvas = document.getElementsByTagName("canvas")[0];
                    canvas.addEventListener("click", null, false);
                    break;
            }
            state = newstate;
        }
        function animate() {
            now = timestamp();
            delta = now - then;
            then = now;
            animDroppingPiece();
            renderer.render(stage);
            requestAnimFrame(animate);
        }

        function mouseDown(data) {
            switch (state) {
                case state_player:
                    if (canvas !== null) {
                        var col = Math.floor((data.x - canvas.offsetLeft) / board.getPieceWidth());
                        userMove(col);
                    }
                    break;
                case state_piece_dropping:
                    break;
            }
        }

        function animDroppingPiece() {
            var brd = board.getBoard();
            if (faller !== null) {
                faller.position.y += (faller.yspeed * delta) / 1000;
                if (faller.position.y > faller.ystop) {
                    faller.position.y = faller.ystop;
                    brd[movecol][moverow] = faller;
                    faller = null;
                    player = 3 - player;
                    setState(state_player);
                }
            }
        }

        function dropPiece() {
            setState(state_piece_dropping);
            faller = new PIXI.Sprite(tex[player]);
            faller.position.x = movecol * board.getPieceWidth();
            faller.position.y = 0;
            faller.yspeed = board.getPieceHeight() * 6;
            faller.ystop = board.getPieceHeight() * moverow;
            faller.player = player;
            gameContainer.addChild(faller);
            then = timestamp();
            board.getBoard().colcnt[movecol]++;
        }

        function tryToDropPiece(col) {
            var row = -1;
            var colcnt = board.getBoard().colcnt[col];
            if (colcnt < board.getColumns()) {
                row = 5 - colcnt;
                movecol = col;
                moverow = row;
                dropPiece();
            }
            return row;
        }

        function userMove(col) {
            var row = tryToDropPiece(col);
        }
    </script>
</body>

</html>